---
title: "edu_knowledge_rothwell"
author: "Sarah McDonald"
date: "7/20/2020"
output: html_document
#output: md_document
---

Download the O*NET Knowledge survey results and O\*NET SOC crosswalk. Only level data are kept (Methodology Step 2). Each ONETSOC code is matched to a SOC Code with the 2010 ONET SOC crosswalk (Step 1).
```{r, warning=F, message=F}
library(readxl)
library(dplyr)

#download.file(url = "https://www.onetcenter.org/dl_files/database/db_24_3_excel/Knowledge.xlsx", destfile = "/sfs/qumulo/qhome/sm9dv/dspg20STW/data/ncses_stw/original/onet/knowledge.xlsx")

#download.file(url = "https://www.onetcenter.org/taxonomy/2010/soc/2010_to_SOC_Crosswalk.xls?fmt=xls", destfile = "/sfs/qumulo/qhome/sm9dv/dspg20STW/data/ncses_stw/original/onet/2010_to_SOC_Crosswalk.xls")

knowledge <- read_xlsx("/sfs/qumulo/qhome/sm9dv/dspg20STW/data/ncses_stw/original/onet/knowledge.xlsx")
xwalk_soc <- read_xls("/sfs/qumulo/qhome/sm9dv/dspg20STW/data/ncses_stw/original/onet/2010_to_SOC_Crosswalk.xls", skip =3)

knowledge <- knowledge[knowledge$`Scale Name` == "Level", ]


knowledge <- merge(knowledge[, c("O*NET-SOC Code", "Element Name",  "Scale Name", "Data Value")], xwalk_soc[, c("O*NET-SOC 2010 Code", "2010 SOC Code")],
      by.x = "O*NET-SOC Code", by.y = "O*NET-SOC 2010 Code", all =  T)

```

Potentially STW competency categories are listed in the variable _element\_stw_.

The mean knowledge score is computed for each SOC and competency category (Step 2, Step 4). O\*NET Categories with at least a 4.5 and competency categories defined in _element\_stw_ will be further considered for STW.

```{r}

element_stw <- c(
"Biology",                    "Building and Construction",
"Chemistry",                  "Computers and Electronics", 
 "Design",                     "Economics and Accounting",  
"Engineering and Technology", "Food Production",           
 "Mathematics",                "Mechanical",                
"Medicine and Dentistry",     "Physics",                   
"Production and Processing",  "Telecommunications")

knowledge_soc <- knowledge %>% 
  group_by(`2010 SOC Code`, `Element Name`) %>% # group by SOC, competency category
  summarize(`Mean Data Value` = mean(`Data Value`)) %>% #take mean for each SOC, competency category grouping
  mutate(`Category STW Indicator` = ifelse(`Element Name` %in% element_stw & `Mean Data Value`>= 4.5, 1, 
                                           ifelse(is.na(`Element Name`)==T|is.na(`Mean Data Value`)==TRUE, NA, 0))) #%>% # if STW competency category and mean value is greater than 4.5, that specific SOC, competency category combination is considered STW for knowledge

knowledge_soc <- knowledge_soc %>%
  select(!`Element Name` & !`Mean Data Value`) %>%
  group_by(`2010 SOC Code`) %>%
  summarize(knowledge_STW = ifelse(length(`2010 SOC Code`)==1 & is.na(`Category STW Indicator`)==T, NA, 
                                   ifelse(length(`2010 SOC Code`)>1 & sum(`Category STW Indicator`, na.rm = T) > 0,1, 0))) %>% summarize(knowledge_STW = unique(knowledge_STW))
# to pass the knowledge STW definition, only one of the SOC, copetency category combinations must have a 1

head(knowledge_soc,10)
```

We then download the Education data and calculate the percentage of respondents without a bachelor's degree (Step 3). We then take the mean percentage of respondents with less than a bachelor’s degree for each SOC code (Step 4).
```{r}
#download.file(url = "https://www.onetcenter.org/dl_files/database/db_24_3_excel/Education%2C%20Training%2C%20and%20Experience.xlsx", destfile = "/sfs/qumulo/qhome/sm9dv/dspg20STW/data/ncses_stw/original/onet/education.xlsx")

education <- read_xlsx("/sfs/qumulo/qhome/sm9dv/dspg20STW/data/ncses_stw/original/onet/education.xlsx")
education <- education[education$`Element Name` == "Required Level of Education", c("O*NET-SOC Code","Title",  "Category", "Data Value")]

education <- merge(education, xwalk_soc[, c("O*NET-SOC 2010 Code", "2010 SOC Code")],
      by.x = "O*NET-SOC Code", by.y = "O*NET-SOC 2010 Code", all = T)

education <- education  %>%
  mutate(hasbach = ifelse(Category <= 5, "nobach", ifelse(Category > 5, "bach", NA))) %>% # if category is greater than 5, the percentage cooresponds to bachelor's degree or higher.
  group_by(`O*NET-SOC Code`, `Title`,  `2010 SOC Code`, hasbach) %>%
  summarize(`Percent No Bachelors` = sum(`Data Value`)) %>%
  filter(hasbach == "nobach"|is.na(hasbach)==TRUE) %>%
  select(!hasbach)
  
# calculate the percentage of respondents for each O*NET without a bachelor's degree

education_soc <- education %>%
  group_by(`2010 SOC Code`) %>%
  summarize(`Mean Percent No Bachelors` = mean(`Percent No Bachelors`, na.rm = T), 
            education_STW = ifelse(`Mean Percent No Bachelors`> 50, 1, ifelse(is.na(`Mean Percent No Bachelors`)==T, NA, 0))) # take the mean percentage of respondents with less than a bachelor’s degree for each SOC code

head(education_soc, 10)

education <- merge(education, education_soc[, c("2010 SOC Code", "education_STW" )], by = "2010 SOC Code")

```

Finally, we merge our knowledge and education findings together. If there is a "1" in both the knowledge and education tables, then a SOC code is categorized as STW. 
```{r}
rothwell <- merge(education, knowledge_soc, by = "2010 SOC Code", all =  T)

rothwell$rothwell_STW <- ifelse(rothwell$knowledge_STW == 1 & rothwell$education_STW ==1, 1, ifelse(is.na(rothwell$knowledge_STW) == T & is.na(rothwell$education_STW) ==T, NA, 0))

head(rothwell, 10)
```

We fix the case where registered nurses fail to meet the knowledge and education criteria (Step 5).
```{r}
rothwell[rothwell$`2010 SOC Code` == "29-1141", "rothwell_STW"] <- 1

#write.csv(rothwell, "/sfs/qumulo/qhome/sm9dv/dspg20STW/src/edu_knowledge_rothwell/rothwell.csv")
```

Merge with OCC
